# Advanced Use

- [Table of Contents](#contents)
  * [Configuration Examples](#config-examples)
  * [Proxy Resolvers](#proxy-resolvers)
  * [Remote Contracts](#remote-contracts)
  * [Intrinsic Gas](#intrinsic-gas)
  * [JSON output](#json-output)

## Config Examples

Some example gas reporter option settings for different use-cases

### L1 Network

*...on a non-ethereum network with very low costs*
```ts
const config: HardhatUserConfig = {
  gasReporter: {
    L1: "fantom",
    currencyDisplayPrecision: 5, // e.g $0.00045
    coinmarketcap: "abc...",
  }
}
```

### L2 Network

*...with live market pricing in €*
```ts
const config: HardhatUserConfig = {
  gasReporter: {
    L2: "optimism",
    currency: "EUR",
    coinmarketcap: "abc...",
  }
}
```

### Libraries and Infrastructure

*...measuring gas usage for constant methods & omitting [intrinsic gas overhead](#intrinsic-gas) for both constant and state-changing methods*
```ts
const config: HardhatUserConfig = {
  gasReporter: {
    // Useful if you have overloaded methods
    showMethodSig: true,

    // Debits intrinsic gas for state-changing method calls in order to model contracts
    // that will never be called by an EOA
    includeIntrinsicGas: false,

    // This option executes an additional `eth_estimateGas` for every `eth_call`
    // detected by the reporter. If you have 1000's of tests setting it to true has a
    // noticeable performance impact
    reportPureAndViewMethods: true,

    // This option can add several seconds to test startup time if you have
    // 100's of contracts in your project. (It parses all the sources in your dependency tree
    // to identify state variable declarations)
    excludeAutoGeneratedGetters: true,
  }
}
```

### Documentation

*...writing report in markdown format to file while displaying regular report on stdout*
```ts
const config: HardhatUserConfig = {
  gasReporter: {
    reportFormat: "markdown",
    outputFile: "gasReport.md",
    forceTerminalOutput: true,
    forceTerminalOutputFormat: "terminal"
  }
}
```

### Data for post-processing

*...saving collected data as JSON, including deployment bytecode*

+ The plugin writes data as JSON to `gasReporterOutput.json` automatically when the environment variable `CI` is set to `true` (This makes it available for CI checks that want to compare gas readings across PRs)
+ See also: [JSON output](#json-output) below

```ts
const config: HardhatUserConfig = {
  gasReporter: {
    outputJSON: true,
    outputJSONFile: "gas.json",
    includeBytecodeInJSON: true,
    suppressTerminalOutput: true
  }
}
```

### Offline and L2
```ts
const config: HardhatUserConfig = {
  gasReporter: {
    offline: true,
    L2: "optimism",
    gasPrice: .00325,     // gwei on L2
    baseFee: 35,           // gwei on L1
    tokenPrice: "4000.00", // USD per ETH
    token: "ETH"
  }
}
```

### Custom `gasPrice` and `block` header data source

The plugin gets its live gas pricing data from Etherscan-like APIs and expects responses in the following format:

```bash
# `eth_gasPrice`
{"result":"0x6fc23ac00"}`.

# `eth_getBlockByNumber`
{ "result": { baseFeePerGas: "0x6fc23ac00", blobBaseFeePerGas: "0x6fc23ac00" } }
```

```ts
const config: HardhatUserConfig = {
  gasReporter: {
    coinmarketcap: "abc...",
    L2: "optimism",
    gasPriceApi: "https://custom.api/latest_gas_price...",
    getBlockApi: "https://custom.api/latest_block_header..."
  }
}
```

## Proxy Resolvers

Some contract systems route calls through proxies (for upgradeability or other reasons) which means the reporter can't know which contract is the target of a transaction without additional help. The `proxyResolver` option lets you define a custom class to help resolve these unindentified method calls.

There are two examples in the code base here to use as templates if you're writing your own:

+ [Etherrouter][1]: an ELI-5 annotated implementation for the [routing system created by Peter Borah][3]
+ [OZ Upgrades][2]: an implementation the plugin uses whenever it detect OZ's upgrades plugin in the Hardhat environment

All proxy resolvers should implement the [CustomGasReporterResolver][4] class interface
```ts
export interface CustomGasReporterResolver {
  /**
   * @property Sync method that returns function signatures to ignore when making `eth_call` queries
   * to resolve contract identities. This is necessary to prevent the reporter getting stuck in an
   * infinite loop when the `reportPureAndViewMethods` option is set
   */
  ignore: () => string[];

  /**
   * @property Async method that receives a JSON RPC transaction and uses its info to resolve
   * a destination contract identity. This method gets bound to the plugin's Resolver class which
   * includes helpers to match addresses to contracts as well as a reference to the HRE
   */
  resolve: (this: Resolver, transaction: JsonRpcTx) => Promise<string | null>;
}
```

To set a custom proxy resolver in the gas reporter's options, instantiate it in `hardhat.config.ts`. Whenever the plugin sees a transaction that's been sent to a contract which doesn't implement its function selector it will query your resolver to see if the true destination is discoverable.
```ts
// hardhat.config.ts
import { MyCustomProxyResolver } from "./mySpecialUtils.ts"

const config: HardhatUserConfig = {
  gasReporter: {
    proxyResolver: new MyCustomProxyResolver(),
  }
}
```

## Remote Contracts

The `remoteContracts` option lets you measure gas for contracts pre-deployed to a forked network. (For now you must supply the plugin with remote contract ABIs. An Etherscan integration to automatically fetch these is in the works [see issue #195][5]) The option can be set as below:
```ts
// hardhat.config.ts
import { wethABI } from "./myRemoteContractABIs";

const config: HardhatUserConfig = {
  gasReporter: {
    remoteContracts: [
      {
        name: "WETH",
        address: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
        abi: wethABI,
      },
    ],
  },
}
```

## Intrinsic Gas

The reporter calculates intrinsic gas overhead for method calls following the formula at [wolfio/evm-opcodes/gas][8] as below. Overhead is always deducted for view and pure method calls and optionally deducted for state-changing methods when the `includeIntrinsicGas` option is set to `false`.

Intrinsic gas is the amount of gas paid prior to execution of a transaction. That is, the gas paid by the initiator of a transaction, which will always be an externally-owned account, before any state updates are made or any code is executed.

Gas Calculation:
- `gas_cost = 21000`: base cost
- `gas_cost += 4 * bytes_zero`: gas added to base cost for every zero byte of memory data
- `gas_cost += 16 * bytes_nonzero`: gas added to base cost for every nonzero byte of memory data

:warning: The execution costs minus intrinsic gas overhead reported by the plugin are **only lower bounds** of what the actual cost will be. (Read [wolfio/evm-opcodes/gas][8] for more info about the complex accounting applied to any given method invocation in reality)

## JSON Output

The JSON output includes the full gas reporter option state (API keys are redacted) and all collected gas data for methods and deployments. The object has the following interface:

```ts
// Top Level
interface GasReporterOutput {
  namespace: string;  // Identifies the json object for post-processing tools
  toolchain: string;  // Gas data source: hardhat or foundry
  version: string;    // Plugin version
  options: GasReporterOptions,
  data?: GasData
}

// Data
interface GasData {
  methods: { [key: string]: MethodDataItem }
  deployments: Deployment[]
}

// Method Data
interface MethodDataItem {
  key: string,
  isCall: boolean,   // When true, method was `view` or `pure`
  contract: string,  // Contract name
  method: string,    // Method name
  fnSig: string,     // Full method call signature
  callData: number[],
  gasData: number[],
  numberOfCalls: number,
  min?: number,
  max?: number,
  executionGasAverage?: number, // L1 or L2 execution costs
  calldataGasAverage?: number,  // L1 data costs for L2
  cost?: string,                // Nation-state currency cost
}

// Deployment Data
interface Deployment {
  name: string,                 // Contract name
  bytecode?: string,            // Set `includeBytecodeInJSON` to `true` to include this
  deployedBytecode?: string,    // Set `includeBytecodeInJSON` to `true` to include this
  callData: number[],
  gasData: number[],
  min?: number,
  max?: number,
  executionGasAverage?: number, // L1 or L2 execution costs
  calldataGasAverage?: number,  // L1 data costs for L2
  cost?: string,                // Nation-state currency cost
  percent?: number              // Percent usage of block gas limit
}

// Options (partial)
interface GasReporterOptions {
  blockGasLimit: number,
  solcInfo: {
    version: string,
    optimizer: boolean, // enabled or not
    runs: number,
    viaIR: boolean
  }
}
```

## Markdown Format Example

Example of a report produced with `reportFormat: "markdown"`:

### Methods
| **Symbol** | **Meaning**                                                                              |
| :--------: | :--------------------------------------------------------------------------------------- |
|    **◯**   | Execution gas for this method does not include intrinsic gas overhead                    |
|    **△**   | Cost was non-zero but below the precision setting for the currency display (see options) |

|                            |    Min |    Max |    Avg | Calls | usd avg |
| :------------------------- | -----: | -----: | -----: | ----: | ------: |
| **MockERC1155**            |        |        |        |       |         |
|     **◯**  *balanceOf*     |      - |      - |  2,470 |    16 | 0.00004 |
|        *mintSpecificId*    | 30,227 | 47,315 | 35,353 |    10 | 0.00064 |
|        *safeTransferFrom*  |      - |      - | 56,868 |     1 | 0.00103 |
|        *setApprovalForAll* | 26,287 | 46,187 | 36,237 |     4 | 0.00065 |
|        *setRoyaltyFee*     |      - |      - | 26,465 |     5 | 0.00048 |

### Deployments
|                 | Min | Max  |       Avg | Block % | usd avg |
| :-------------- | --: | ---: | --------: | ------: | ------: |
| **MockERC1155** |   - |    - | 1,605,613 |   5.4 % | 0.02897 |

### Solidity and Network Config
| **Settings**        | **Value**    |
| ------------------- | ------------ |
| Solidity: version   | 0.8.24       |
| Solidity: optimized | true         |
| Solidity: runs      | 9999999      |
| Solidity: viaIR     | true         |
| Block Limit         | 30,000,000   |
| L1 Gas Price        | 22 gwei      |
| Token Price         | 0.82 usd/ftm |
| Network             | FANTOM       |
| Toolchain           | hardhat      |


[1]: https://github.com/cgewecke/hardhat-gas-reporter/blob/master/src/lib/resolvers/etherrouter.ts
[2]: https://github.com/cgewecke/hardhat-gas-reporter/blob/master/src/lib/resolvers/oz.ts
[3]: https://github.com/PeterBorah/ether-router
[4]: https://github.com/cgewecke/hardhat-gas-reporter/blob/master/src/types.ts
[5]: https://github.com/cgewecke/hardhat-gas-reporter/issues/195
[8]: https://github.com/wolflo/evm-opcodes/blob/main/gas.md#a0-0-intrinsic-gas
